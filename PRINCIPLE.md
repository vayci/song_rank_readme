### 『你在听歌吗』程序是怎么工作的

在『你在听歌吗』关注用户之后，程序每分钟都会获取用户的听歌排行榜数据。当听歌排行榜数据发送变化时，程序就会判断，是不是用户当前听歌导致的变化。如果是，那就会记录歌曲数据，并通知到关注者。

但是有以下几点结论需要明确：

1. *并不是用户听的每首歌都能获取到听歌记录*
2. *程序只会记录“实时听歌记录”*
3. *听歌排行榜数据变化，并不一定是用户当天听了歌*
4. *听歌数量变化是用户听了歌，但不一定产生“实时听歌记录”，程序不一定能够获取到记录*

为什么有这么几个结论，需要从网易云音乐的排行榜计算说起。

### 网易云音乐排行榜计算原理

为什么需要判断是不是用户听歌导致的排行榜数据变化？因为排行榜的数据变化，并不一定是用户即时听了歌产生的。

排行榜数据变化主要包含以下几种情况：

1. 排行榜固定计算刷新

每天凌晨3-7点，网易云会重新计算用户的排行榜数据。为什么会每天计算呢？因为周排行榜是根据用户近7天的听歌数据计算的。例如今天是6月7日，那么周排行榜的数据是依据6月1日至6月7日进行计算的；而到了6月8日，就需要移除6月1日的数据，使用6月2日到6月8日的数据进行计算。6月1日听的听的歌，就不能出现在周排行榜上面了。这部分数据变化，程序不会记录。

1. 用户听歌

一般来说，用户使用网易云听歌，记录会实时更新到周排行榜，我将这种数据称为“实时听歌记录”。**程序抓取的就是这部分实时听歌记录。**但是，并不是用户听的每首歌都会及时地更新到周排行榜上产生变化，后面会对这种情况进行详细的解释。

1. 排行榜批量修正

不同于第一种情况，网易云在固定的时间段对用户的排行榜进行计算。**当用户的听歌数据因为某些原因（用户网络状况、网易云服务器负载等）没及时更新，那网易云服务器可能会在某一个时间将多首歌的听歌记录更新到排行榜上面。**对于这种情况，因为同一时间更新了多条变化记录，不能确定具体哪一首歌是哪一个时间点产生的，程序也判定为不是实时听歌记录，也不会进行记录。



### 为什么用户听了歌，程序没有记录

在上面排行榜的计算原理中已经说到，对于听歌排行榜固定计算刷新以及批量修正的情况，程序都不会进行记录。**也就是说，一定要用户听了歌，并且数据及时更新到了听歌排行榜上面，程序才能够正常判定并记录数据。**这个更新到排行榜的过程，是网易云内部的处理流程，程序是没法参与的。程序只能够保证每分钟去正确获取到排行榜数据，找出变化并根据算法计算而已。**程序界面上的“UPDATE TIME”，也就是程序上一次去正确获取数据的时间。**



除了上述的这些情况，还存在一种特殊情况也不能获取到听歌记录数据。那就是用户听歌后，记录数据没有“上榜”。上榜其实就是听歌数据更新到周排行榜上面，原理是一样的。但这种情况特殊在于，用户的听歌数据及时上报到了网易云服务器了，只是排行榜没有位置了。因为每个人的排行榜最多显示100首歌，并且是按听歌次数倒序排列。因此，如果一个用户的周排行榜已经满了100首歌，那这个时候如果听一首不在排行榜内的歌，相当于这首歌只听了一次，那很可能这首歌不能够出现在排行榜内，那么程序也没法感知到用户听歌并对数据进行记录。



链接：[网页版使用说明](README.md)